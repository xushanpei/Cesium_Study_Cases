> 哈喽,大家好 我是 `xy`👨🏻‍💻。这篇文章是 `Cesium 三维地球可视化从入门到进阶`专栏的第二篇，这篇文章主要对 Cesium 中基础核心类 Viewer、Scene 属性的一些使用讲解以及如何架加载第三方影像、地形服务、坐标、相机、追踪、交互等,


在 `Cesium` 中有几个比较核心的类,也是开发过程中比较常用的:

- `Viewer`: Cesium的核心类，对应着Cesium展示三维要素内容的主窗口
- `Scene`: 是在 Viewer 或 CesiumWidget 内部隐式创建的
- `Camera`: `Camera`主要用来描述和操作场景的视角



## 视图 Viewer

`Viewer` 是 `Cesium` 的核心类，对应着 `Cesium` 展示三维要素内容的主窗口。

它不仅仅是包含三维地球的视窗，还包含一些基础控件，所以在定义Viewer对象的同时需要设定基础部件、图层等的初始化状态。

Cesium开发的大部分工作在Scene场景中执行，包括调用图层、3D Tiles数据加载、场景交互等。

另外Cesium提供了Entity、DataSource等封装好的数据加载方式,降低了三维开发难度。

`Viewer`对象主要包括如下属性：

- `camera`：相机属性，主要用于控制视角；
- `widgets`（非属性）：`widgets`并非`Viewer`对象的属性，在这里特指所有控件：
  - `animation`：动画控件；
  - `baseLayerPicker`：影像图层选择器；
  - `fullscreenButton`：全屏按钮；
  - `geocoder`：查找位置；
  - `homeButton`：返回视角到初始位置；
  - `navigationHelpButton`：帮助按钮；
  - `timeline`：时间轴；
  - `vrButton `：VR按钮。
- `imageryLayers`：影像图层集合；
- `terrainProvider`：地形提供者；
- `entities`：实体集合；
- `dataSources`：矢量数据集合；
- `Event`（非属性）：`Event`并非`Viewer`对象的属性，在这里特指所有事件：
  - `screenSpaceEventHandler`：屏幕操作事件；
  - `selectedEntityChanged`：选取实体事件；
  - `trackedEntityChanged`：追踪实体事件。
- `scene`：场景，`scene`是`Viewer`对象的属性，但它也是Cesium中的一个关键的对象，用于添加图形（`primitive`）、添加场景特效和添加场景事件

在上一篇文章中,我们已经对 Viewer 的一些基本的配置做了详解, 如果还不会配置的小伙伴可以直接点击链接去学习: [三维地球可视化从入门到进阶 - 基础详解](https://juejin.cn/post/7148052684203884558)


## 场景 Scene

`Scene` 是构建`场景`的类, 是 `Cesium` 中非常重要的类。`Cesium` 开发大多基于 `Scene` 类，其主要包含四部分内容：

- 基础地理环境设置，如`地球`参数（globe）、`光照`（light）、`雾`（fog）、`大气`（skyAtmosphere）
- 基础图层设置，包含`地图图层`、`地形图层`等
- 场景数据，`Cesium` 底层空间数据绘制方式是依赖 `Primitive`。Primitive API功能强大而且非常灵活.为程序员绘制高级图形提供很大自由度、开发者可根据图形学原理自定义高级图形。技术难度较大，对于初学者较为困难，相比较面言`Entity`封装程度高，构造简单，使用便捷，目前不支持自定义。`3D Tiles`是Primitive的非常重要部分，可以实现大数据量加载
- 场景交互函数，如`pick`（鼠标事件）、`camera`（相机事件）

## 相机 Camera
`Cesium` 通过相机来控制场景中的`视域`、`旋转`、`缩放`、`平移`等操作都可控制相机移动,使用相机`Camera`操作场景分为如下几类：

- 飞行 fly：`flyHome`、`flyTo`和`flyToBoundingSphere`，与 fly 有关的方法的特点就是在改变相机视角时会伴随飞行动画；这类方法一定会改变相机的位置，但是不一定会改变相机的朝向；
- 缩放 zoom：`zoomIn`和`zoomOut`，与 zoom 有关的方法类似于使用鼠标滚轮来操作场景进行缩小或放大；这类方法不会改变相机的朝向，只会改变相机的位置；
- 移动 move ：`moveBackward`、`moveDown`、`moveForward`、`moveLeft`、`moveRight`和`moveUp`，与 move 有关的方法就是在前后左右上下这六个方向上移动相机，这类方法不会改变相机的朝向，只会改变相机的位置；
- 视角 look ：`lookDown`、`lookLeft`、`lookRight`和`lookUp`，与 look 有关的方法就是在相机位置不变的情况下，调整相机镜头的上下左右四个方向朝向，这类方法不会改变相机的位置，只会改变相机的朝向；
- 扭转 twist ：`twistLeft`和`twistRight`，与 twist 有关的方法就是在相机位置不变的情况下，调整相机视角向左（逆时针）或向右（顺时针）扭转，这类方法不会改变相机的位置，只会改变相机的朝向；
- 旋转 rotate ：`rotateDown`、`rotateLeft`、`rotateRight`和`rotateUp`，与 rotate 有关的方法会根据提供的角度参数旋转相机视角，这类方法会改变相机的位置，也会改变相机的朝向；
- 其他操作相机的方法：
  - `setView`直接将相机视角定位到某个位置；
  - `lookAt`直接将相机视角定位到某个位置，但是会锁定相机视角。


## viewer Scene Camera 常用配置


下面给大家总结一些 viewer Scene Camera 常用的一些配置


1. 去除 Cesium 版权图标

```js
viewer.cesiumWidget.creditContainer.style.display = "none";
```

2. 显示帧数
```js
viewer.scene.debugShowFramesPerSecond = true;
```

3. 增加太阳光照
```js
viewer.scene.globe.enableLighting = true;
```

4. 大气层显示
```js
viewer.scene.skyAtmosphere.show = true;
```

5. 开启地形深度检测
```js
viewer.scene.globe.depthTestAgainstTerrain = true;
```

6. 禁止相机进入地下
```js
viewer.scene.globe.depthTestAgainstTerrain = true;
```

7. 右键拖拽场景倾斜

```js
viewer.scene.screenSpaceCameraController.tiltEventTypes = Cesium.CameraEventType.RIGHT_DRAG
```

8. 关闭抗锯齿
```js
viewer.scene.fxaa = false;
viewer.scene.postProcessStages.fxaa.enabled = false;
```


9. 鼠标操作惯性控制

```js
//关闭旋转惯性
viewer.scene.screenSpaceCameraController.inertiaSpin = 0
//关闭平移惯性
viewer.scene.screenSpaceCameraController.inertiaTranslate = 0
//关闭缩放惯性
viewer.scene.screenSpaceCameraController.inertiaZoom = 0
```

10. 自动调整分辨率

```js
var supportsImageRenderingPixelated =
    viewer.cesiumWidget._supportsImageRenderingPixelated;
  if (supportsImageRenderingPixelated) {
    var vtxf_dpr = window.devicePixelRatio;
    while (vtxf_dpr >= 2.0) {
      vtxf_dpr /= 2.0;
    }
    viewer.resolutionScale = vtxf_dpr;
  }
```

11. 默认定位到中国

```js
Cesium.Camera.DEFAULT_VIEW_RECTANGLE = Cesium.Rectangle.fromDegrees(
  75.0, // 东
  0.0, // 南
  140.0, // 西
  60.0 // 北
);
```
12. 修改天空背景盒样式

```js
var scene=viewer.scene;
scene.skyBox = new Cesium.SkyBox({
    sources : {
        positiveX: "/skyBox/00h+00.jpg",
        negativeX: "skyBox/12h+00.jpg",
        positiveY: "/skyBox/06h+00.jpg",
        negativeY: "/skyBox/18h+00.jpg",
        positiveZ: "/skyBox/06h+90.jpg",
        negativeZ: "/skyBox/06h-90.jpg",
    }
});
```

## 基础图层设置

加载第三方图层



## 事件简介

http://syzdev.cn/cesium-docs/advance/event-introduction.html

























primitives 图元集合（几何体和外观）
postProcessStages 场景后期处理
环境对象，大气圈、天空盒、太阳、月亮等
Event事件，更新、渲染事件等
Camera类属性
位置、方位角、俯仰角、翻滚角



imageryLayers 影像数据
terrainProvider 地形数据
dataSources 矢量数据
entities 几何实体集合（用于空间数据可视化）
Widgets 组件，即Viewer初始化界面上的组件
Camera 相机
Event 事件，鼠标事件、实体选中事件等

## 空间计算

三维矩阵、四元数、四维矩阵、转换等

Viewer
Viewer类对应地图可视化展示的主窗口，Viewer对象创建的语句为:

new Cesium.Viewer(cesium.Container,options);
1
其中，cesiumContainer是地图主窗口div的ID，options指Cesium.Viewer可选设置参数，包含图层、地形、时间系统等参数，种类多样。接下来通过例子介绍常用的选项设置。

new Cesium.Viewer('cesiumContainer', {
        geocoder: false,   // 位置查找工具
        baseLayerPicker: false,// 图层选择器（地形影像服务）
        timeline: false, // 底部时间线
        homeButton: false,// 视角返回初始位置
        fullscreenButton: false, // 全屏
        animation: false,   // 左下角仪表盘（动画器件）
        sceneModePicker: false,// 选择视角的模式（球体、平铺、斜视平铺）
        navigationHelpButton: false, //导航帮助按钮
    });

Scene
Scene是构建场景的类。是Csium中非常重要的类。Cesium开发大多基于Scene类，其主要包含四部分内容：

第一部分是基础地理环境设置，如地球参数（globe）、光照（light）、雾（fog）、大气（skyAtmosphere）

第二部分是基础图层设置，包含地图图层、地形图层等，需要注意在Viewer类中设置图层等价于在Scene中设置图层，console.log(viewer.imageryLayers==viewer. scene.imageryLayers)显示”true“，意味着Viewer和Scene中imageryLayers属性相同。

第三部分是场景数据，Cesium底层空间数据绘制方式是依赖Primitive。Primitive API功能强大面且非常灵活.为程序员绘制高级图形提供很大自由度、开发者可根据图形学原理自定义高级图形。技术难度较大，对于初学者较为困难，相比较面言Entity封装程度高，构造简单，使用便捷，目前不支持自定义。3D Tiles是Primitive的非常重要部分，可以实现大数据量加载。

第四部分则是场景交互函数，如pick（鼠标事件）、camera（相机事件）。需要注意的是，conole.log（viewer.camera==viewer.scene.camera）显示"true"，表示Viewer和Scene中camera属性相同。

Entity
Entity是由，Primitive封装而来，但是Entity并不属于Scene。Entity API是对高层次抽象对象的一致性的设计，这些对象将相关的可视化和信息整合成统一的数据结构，称之为Entity，使得开发者专注于数据的呈现，而不必关心底层的可视化机制。它还提供了用于构建复杂的、时间动态可视化的结构，与静态数据自然地结在一起。 虽然Entity API底层上使用了Primitive API实现，但这是一个实现细节，几乎不必关心。Entity API能够提供灵活的、高性能的可视化，同时提供一致性的、 易于学习的、易于使用的接口。由于Entity易学易用，而且功能丰富。在简单场景开发过程中，Entity的使用频率要高于Primitive。





DataSourceCollection
DataSoureCollection是Cesium中加载矢量数据的主要方式之一，最大特点是支持加载矢量数据集与外部文件的调用，主要分为CzmlDataSource、KmlDataSource、GeoJsonDataSource三种，分别对应加载CZML、KML和 GeoJSON格式数据。GIS开发中加载矢量数据是必不可少的功能，将矢量数据转换为以上任意一种方式，便可在Cesium中实现矢量数据的加载和存取。

坐标转换

加载影像数据 地形数据

矢量数据

加载第三方图层

entity 详解

geoserver : https://blog.csdn.net/javawebrookie/article/details/98847947

四种雷达扫描效果: https://blog.csdn.net/qq_41400354/article/details/122509169?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-122509169-blog-115304182.pc_relevant_multi_platform_whitelistv3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-122509169-blog-115304182.pc_relevant_multi_platform_whitelistv3&utm_relevant_index=4



http://www.zgeo.work/cesiumTx/examples/editor.html#development_3d_models



https://juejin.cn/post/7057776364010602526



http://syzdev.cn/cesium-docs/advance/scene-load-event.html#%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E4%BA%8B%E4%BB%B6


天气效果: https://blog.csdn.net/qq_36213352/article/details/122541959